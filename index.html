<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="styles.css">
	
	<script src="lib/d3.min.js" charset="utf-8"></script>
	<script src="lib/d3-tip.min.js"></script>
    <script src="lib/jquery-2.2.3.min.js"></script>
	
    <script src="bubbleview.js"></script>
    <script src="zoomview.js"></script>
    <script src="teamstats.js"></script>
    <script src="field.js"></script>

    <script>

        var visibleBoolean = false;

        function drawAll() {
            d3.select(".bubblechart").remove();
            d3.select(".d3-tip").remove();
            drawBubbles(bubbleSvg, 0, 0, width, height - 200, year, false);
            drawFullTeamChange(year);
        }

        function drawFullTeamChange(year) {
            drawTeamChange(year);
            drawTeamStats(teamSvg, 0, 0, width, 180, year, team.team);
        }


        function drawTeamChange(year) {
            redrawZoom(year);
            redrawField(year);
            drawBubbles(miniBubbleSvg, 0, 0, miniw, minih, year, true);
        }

        function redrawZoom(year) {
            drawZoom(zoomSvg, 0, 0, 0.8 * width, height - 380, year, team.team);
        }

        function redrawField(year) {
            drawField(fieldSvg, 0, 0, 0.8 * width, height - 380, year, team.team);
        }


        function drawBubbles(svg, x, y, w, h, year, back) {
            d3.select(".backbubble").remove();
            if (back) {
                svg.append("rect")
                    .attr("class", "backbubble")
                    .attr("fill", "lightgrey")
                    //.attr("opacity", "0")
                    .attr("x", x)
                    .attr("y", y)
                    .attr("width", w)
                    .attr("height", h);
            }
 
            drawCircles(theData.filter(function(d) {return d.year == year}), "srs", "leaguerank", "playoffrank", "team", svg, x, y, w, h, back);

            // d3.selectAll(".teambubble")
            //     .on("click", function(d) {
            //         team = d.team;
            //         $("#bubbleheader h1").text(team);
            //         if (view === "bubble") {
            //             scrollMe("zoom");
            //         }
            //         drawFullTeamChange(window.year);
            //     });

            d3.select(".backbubble")
                .on("click", function(d) {
                    if (!(view === "bubble")) {
                        scrollMe("bubble");
                    }
                });
        }

        function drawZoom(svg, x, y, w, h, year, team) {
            drawTransfers(theData, team, year, svg, x, y, w, h, playerDataSelector, playerScaler);
        }

        function drawTeamStats(svg, x, y, w, h, year, team) {
            drawTs(theData, team, year, svg, x, y, w, h);
        }

        function drawField(svg, x, y, w, h, year, team) {
            drawF(theData, team, year, svg, x, y, w, h, playerDataSelector, playerScaler);
        }
    </script>
</head>

<body>
    <div class="wrapper" id="wrapper">
			<main>
					<div id="InfoVis">
                            <div class="allviss">
                                <div class="scrollable">
                                    <div class="headerblocker" id="containerInfo">
                                        <div class="info" id="legende"></div>
                                    </div>
                                    <div class="visualization" id="bubblevis"></div>
                                    <div class="headerblocker" id="zoomblocker">
                                        <div class="visualization stick" id="bubbleheader">
                                            <h1 id="teamname"></h1>
                                            <table>
                                                <tr>
                                                    <td> <h2 id="yearname"></h2> </td>
                                                    <td> <p id="srs"></p> </td>
                                                </tr>
                                                <tr>
                                                    <td></td>
                                                    <td> <p id="playoffrank"></p></td>
                                                </tr>
                                                    <td></td>
                                                    <td> <p id="leaguerank"></p></td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="visualization" id="minibubbles"></div>
                                    </div>
                                    <div class="viswrapper" id="zoomviswrapper">
                                        <div id="sidebar">
                                            <div id="varchoosesidebar">
                                                    <form id="playervarform">
                                                        <ul>
                                                            <li>
                                                                <input type="radio" value="PER" id="perradio" name="varchoose" checked="checked">
                                                                <label for="perradio">PER</label>
                                                            </li>
                                                            <li>
                                                                <input type="radio" value="Age" id="ageradio" name="varchoose">
                                                                <label for="ageradio">Age</label>
                                                            </li>
                                                            <li>
                                                                <input type="radio" value="efg" id="efgradio" name="varchoose">
                                                                <label for="efgradio">eFG%</label>
                                                            </li>
                                                            <li>
                                                                <input type="radio" value="ortg" id="ortgradio" name="varchoose">
                                                                <label for="ortgradio">ORtg</label>
                                                            </li>
                                                            <li>
                                                                <input type="radio" value="drtg" id="drtgradio" name="varchoose">
                                                                <label for="drtgradio">DRtg</label>
                                                            </li>
                                                        </ul>
                                                    </form>
                                            </div>
                                            <div id="playerinfo">
                                                <h2 id="playername"></h2>
                                                <p id="playerper"></p>
                                                <p id="playerefg"></p>
                                                <p id="playerortg"></p>
                                                <p id="playerdrtg"></p>
                                                <!--<p id="playerheight"></p>-->
                                                <!--<p id="playerweight"></p>-->
                                                <p id="playerbirthday"></p>
                                            </div>
                                        </div>
                                        <div class="visualization" id="zoomvis" ></div>
                                    </div>
                                    <div class="visualization" id="teamvis"></div>
                                    <div class="headerblocker" id="fieldblocker"></div>
                                    <div class="viswrapper">
                                        <div class="visualization" id="fieldvis"> </div>
                                    </div>
                                </div>
                                <div class="visualization" id="timelinefooter">
                                    <p>
                                        <input class="timeline" type="range" min="1985" max="2015" id="year" value=2015>
                                        <p id="yearSlider">2015</p>
                                    </p>
                                </div>
                            </div>

							<script type="text/javascript">
                                var playerDataSelector = function(p) { return p.advanced.PER; };
                                var playerScaler = exagerratedPerScale;

                                $("#perradio").click(function() {
                                    playerDataSelector = function (p) {return p.advanced.PER; };
                                    playerScaler = exagerratedPerScale;
                                    redrawZoom(window.year);
                                    redrawField(window.year);
                                });

                                $('#ageradio').click(function() {
                                    playerDataSelector = function(p) {return p.totals.Age; };
                                    playerScaler = d3.scale.linear().range([0.3,2]).domain([18,40]);
                                    redrawZoom(window.year);
                                    redrawField(window.year);
                                });

                                $('#efgradio').click(function() {
                                    playerDataSelector = function(p) {return p.totals['eFG%']; };
                                    playerScaler = d3.scale.linear().range([0.3,2]).domain([0.3,0.7]);
                                    redrawZoom(window.year);
                                    redrawField(window.year);
                                });

                                $('#ortgradio').click(function() {
                                    playerDataSelector = function(p) {return p.perposs['ORtg']; };
                                    playerScaler = d3.scale.linear().range([0.3,2]).domain([80,130]);
                                    redrawZoom(window.year);
                                    redrawField(window.year);
                                });

                                $('#drtgradio').click(function() {
                                    playerDataSelector = function(p) {return p.perposs['DRtg']; };
                                    playerScaler = d3.scale.linear().range([0.3,2]).domain([80,130]);
                                    redrawZoom(window.year);
                                    redrawField(window.year);
                                });

                                drawLegend();
                                var view = "bubble";


                                $(window).scroll(movescroll);
                                movescroll();

                                $('#bubbleheader').css("width", "" + ($('#wrapper').width() - $('#legende').width()) + "px");
                                $('#zoomviswrapper').css("height", "" + ($(window).height() - $('#bubbleheader').height() - $('#timelinefooter').height() - $('#teamvis').height()) + "px");

                                function scrollMe(where) {
                                    if (where === "bubble") {
                                        $("html, body").animate({ scrollTop: $('#containerInfo').offset().top }, 600);
                                        $('#minibubbles').removeClass('stick');
                                        $('#teamvis').removeClass('stick');
                                        $('#sidebar').removeClass('stick');
                                        $('#varchoosesidebar').removeClass('stick');
                                        $('#playerinfo').removeClass('stick');
                                        $('#minibubbles').css("left", "");
                                        view = "scrollingbubble";
                                    } else if (where === "zoom") {
                                        $("html, body").animate({ scrollTop: $('#zoomblocker').offset().top }, 600);
                                        view = "scrollingzoom";
                                    } else if (where === "field") {
                                        $("html, body").animate({ scrollTop: $('#fieldblocker').offset().top }, 600);
                                        view = "scrollingfield";
                                    }
                                }

                                function movescroll() {
                                    var window_top = $(window).scrollTop();

                                    if (view === "scrollingbubble" && window_top == $('#containerInfo').offset().top) {
                                        view = "bubble";
                                    } else if (view === "scrollingzoom" && window_top == $('#zoomblocker').offset().top) {
                                        $('#teamvis').addClass('stick');
                                        $('#sidebar').addClass('stick');
                                        $('#varchoosesidebar').addClass('stick');
                                        $('#playerinfo').addClass('stick');
                                        $('#minibubbles').addClass('stick');
                                        $('#minibubbles').css("left", $('#zoomblocker').offset().left + ($('#wrapper').width() - $('#minibubbles').width()) + "px");
                                        view = "zoom";
                                    } else if (view === "scrollingfield" && window_top == $('#fieldblocker').offset().top) {
                                        view = "field";
                                    } else if (view === "bubble" && window_top > $('#containerInfo').offset().top) {
                                        scrollMe("zoom");
                                    } else if (view === "zoom") {
                                        if (window_top < $('#zoomblocker').offset().top) {
                                            scrollMe("bubble");
                                        } else if (window_top > $('#zoomblocker').offset().top) {
                                            scrollMe("field");
                                        }
                                    } else if (view === "field") {
                                        if (window_top < $('#fieldblocker').offset().top) {
                                            scrollMe("zoom");
                                        }
                                    }
                                }

                                var width = 1000,
                                    height = window.innerHeight - $('#timelinefooter').height() ;

                                var miniw = $('#minibubbles').width(),
                                    minih = $('#minibubbles').height();


                                var bubbleSvg = d3.select("#bubblevis")
                                    .append("svg")
                                    .attr("width", width)
                                    .attr("height", height - $('#zoomblocker').height() )

                                var miniBubbleSvg = d3.select("#minibubbles")
                                    .append("svg")
                                    .attr("width", miniw)
                                    .attr("height", minih)

                                var zoomSvg = d3.select("#zoomvis")
                                    .append("svg")
                                    .attr("width", 0.8 * width)
                                    .attr("height", height - $('#zoomblocker').height() - 200)

                                var teamSvg = d3.select("#teamvis");

                                var fieldSvg = d3.select("#fieldvis")
                                    .append("svg")
                                    .attr("width", 0.8 * width)

                                    .attr("height", height - $('#zoomblocker').height())

                                //var view = "bubble";

                                window.year = 2015;

								d3.select("#year").on("input", function() {
									window.year = +this.value
									document.getElementById("yearSlider").innerHTML= year;
                                    window.team = theData.find(function(d) {return d.year == window.year; }).teams.find(function(d) { return d.team === window.team.team;});
                                    updateTeamInfo(window.team, window.year);

                                    drawAll();
                                });

                                var theData;
                                var team;
                                //var visibleBoolean = false;


                                d3.json("combined.json", function(data) {
                                   theData = data;
                                   team = theData.find(function(d) { return d.year == 2015; }).teams.find(function(d) {return d.team == "Chicago Bulls"});
                                    drawAll();
                                    $(window).scrollTop(0);
                                    updateTeamInfo(window.team, window.year);
                                });

							</script>
					</div>							
			</main>
		
			<!--<footer>-->
				<!--<p>Yves Langeraert - <a href = "https://thetuftersblog.wordpress.com/">The Tufters</a> - InfoVis1516</p>-->
			<!--</footer>-->
	</div>
</body>
</html>
